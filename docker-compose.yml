version: '3.9'

services:
  postgres-auth:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: orderly
      POSTGRES_PASSWORD: orderly
      POSTGRES_DB: orderly_auth
    ports:
      - '5433:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U orderly -d orderly_auth']
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - postgres-auth-data:/var/lib/postgresql/data

  auth-service:
    build:
      context: .
      dockerfile: apps/services/auth-service/Dockerfile
    depends_on:
      postgres-auth:
        condition: service_healthy
    environment:
      NODE_ENV: development
      DB_HOST: postgres-auth
      DB_PORT: 5432
      DB_USER: orderly
      DB_PASSWORD: orderly
      DB_NAME: orderly_auth
      TYPEORM_SYNC: 'true'
      JWT_SECRET: orderly-dev-secret
    ports:
      - '3000:3000'
    volumes:
      - ./apps/services/auth-service:/usr/src/app/apps/services/auth-service

  postgres-orders:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: orderly
      POSTGRES_PASSWORD: orderly
      POSTGRES_DB: orderly_orders
    ports:
      - '5434:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U orderly -d orderly_orders']
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - postgres-orders-data:/var/lib/postgresql/data

  orders-service:
    build:
      context: .
      dockerfile: apps/services/orders-service/Dockerfile
    depends_on:
      postgres-orders:
        condition: service_healthy
    environment:
      NODE_ENV: development
      PORT: 3000
      DB_HOST: postgres-orders
      DB_PORT: 5432
      DB_USER: orderly
      DB_PASSWORD: orderly
      DB_NAME: orderly_orders
      TYPEORM_SYNC: 'true'
      KAFKA_BROKERS: kafka:9092
      KAFKA_CLIENT_ID: orders-service
      ORDERS_CREATED_TOPIC: orders.order.created
      ORDERS_STATUS_CHANGED_TOPIC: orders.order.statusChanged
      CATALOG_SERVICE_BASE_URL: http://catalog-service:3000/v1
      CATALOG_SERVICE_TIMEOUT: 5000
    ports:
      - '3002:3000'
    volumes:
      - ./apps/services/orders-service:/usr/src/app/apps/services/orders-service
      - ./packages/shared-kernel:/usr/src/app/packages/shared-kernel

  postgres-payments:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: orderly
      POSTGRES_PASSWORD: orderly
      POSTGRES_DB: orderly_payments
    ports:
      - '5435:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U orderly -d orderly_payments']
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - postgres-payments-data:/var/lib/postgresql/data

  payments-service:
    build:
      context: .
      dockerfile: apps/services/payments-service/Dockerfile
    depends_on:
      postgres-payments:
        condition: service_healthy
      kafka:
        condition: service_started
    environment:
      NODE_ENV: development
      PORT: 3000
      DB_HOST: postgres-payments
      DB_PORT: 5432
      DB_USER: orderly
      DB_PASSWORD: orderly
      DB_NAME: orderly_payments
      TYPEORM_SYNC: 'true'
      KAFKA_BROKERS: kafka:9092
      KAFKA_CLIENT_ID: payments-service
      PAYMENTS_REQUESTED_TOPIC: payments.payment.requested
      PAYMENTS_SUCCEEDED_TOPIC: payments.payment.succeeded
      PAYMENTS_FAILED_TOPIC: payments.payment.failed
      PAYMENTS_CANCELLED_TOPIC: payments.payment.cancelled
      MOCK_PAYMENTS_DECLINE_THRESHOLD: 500000
    ports:
      - '3003:3000'
    volumes:
      - ./apps/services/payments-service:/usr/src/app/apps/services/payments-service
      - ./packages/shared-kernel:/usr/src/app/packages/shared-kernel

  postgres-catalog:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: orderly
      POSTGRES_PASSWORD: orderly
      POSTGRES_DB: orderly_catalog
    ports:
      - '5436:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U orderly -d orderly_catalog']
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - postgres-catalog-data:/var/lib/postgresql/data

  catalog-service:
    build:
      context: .
      dockerfile: apps/services/catalog-service/Dockerfile
    depends_on:
      postgres-catalog:
        condition: service_healthy
    environment:
      NODE_ENV: development
      PORT: 3000
      DB_HOST: postgres-catalog
      DB_PORT: 5432
      DB_USER: orderly
      DB_PASSWORD: orderly
      DB_NAME: orderly_catalog
      TYPEORM_SYNC: 'true'
      KAFKA_BROKERS: kafka:9092
      KAFKA_CLIENT_ID: catalog-service
      CATALOG_CREATED_TOPIC: catalog.product.created
      CATALOG_UPDATED_TOPIC: catalog.product.updated
      CATALOG_STATUS_CHANGED_TOPIC: catalog.product.statusChanged
      CATALOG_ADMIN_TOKEN: catalog-admin-secret
    ports:
      - '3004:3000'
    volumes:
      - ./apps/services/catalog-service:/usr/src/app/apps/services/catalog-service
      - ./packages/shared-kernel:/usr/src/app/packages/shared-kernel

  api-gateway:
    build:
      context: .
      dockerfile: apps/api-gateway/Dockerfile
    depends_on:
      auth-service:
        condition: service_started
      orders-service:
        condition: service_started
    environment:
      NODE_ENV: development
      PORT: 4000
      AUTH_SERVICE_BASE_URL: http://auth-service:3000/v1/auth
      AUTH_SERVICE_TIMEOUT: 5000
      AUTH_JWT_SECRET: orderly-dev-secret
      CORRELATION_HEADER: x-correlation-id
      ORDERS_SERVICE_BASE_URL: http://orders-service:3000/v1/orders
      ORDERS_SERVICE_TIMEOUT: 5000
      ORDERS_SERVICE_ANONYMOUS_USER_ID: anonymous-web-user
      ORDERS_SERVICE_ANONYMOUS_EMAIL:
      PAYMENTS_SERVICE_BASE_URL: http://payments-service:3000/v1/payments
      PAYMENTS_SERVICE_TIMEOUT: 5000
      CATALOG_SERVICE_BASE_URL: http://catalog-service:3000/v1
      CATALOG_SERVICE_TIMEOUT: 5000
      CATALOG_ADMIN_TOKEN: catalog-admin-secret
    ports:
      - '4000:4000'
    volumes:
      - ./apps/api-gateway:/usr/src/app/apps/api-gateway
      - ./packages/shared-kernel:/usr/src/app/packages/shared-kernel

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - '2181:2181'

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    restart: unless-stopped
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    ports:
      - '9092:9092'
      - '9093:9093'

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    restart: unless-stopped
    depends_on:
      - kafka
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    ports:
      - '9094:8080'

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    depends_on:
      - api-gateway
    environment:
      NODE_ENV: development
      API_GATEWAY_BASE_URL: http://api-gateway:4000/v1
      PORT: 3000
    ports:
      - '3001:3000'
    volumes:
      - ./apps/web:/app/apps/web
      - ./packages/shared-kernel:/app/packages/shared-kernel

volumes:
  postgres-auth-data:
  postgres-orders-data:
  postgres-payments-data:
  postgres-catalog-data:
